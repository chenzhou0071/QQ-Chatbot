# QQ智能聊天机器人 - 项目概览

## 📋 项目简介

这是一个基于 **NoneBot2 + NapCat** 架构的智能QQ聊天机器人，集成了对话智能、三层记忆系统、联网搜索等先进功能，能够实现自然、智能的群聊互动。

### 核心特点

- 🧠 **对话智能**：意图分析、状态感知、主动对话
- 💾 **三层记忆**：短期缓存 + 长期存储 + 语义搜索
- 🌐 **联网搜索**：实时获取网络信息
- 👥 **群友管理**：自动收集信息、生日提醒、活跃度统计
- 🎭 **人设系统**：可自定义性格和说话风格
- 🔌 **插件化**：模块化设计，易于扩展

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                      QQ 用户/群聊                        │
└────────────────────┬────────────────────────────────────┘
                     │ OneBot V11 协议
┌────────────────────▼────────────────────────────────────┐
│                    NapCat (协议端)                       │
│              WebSocket 连接 (ws://127.0.0.1:8080)       │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                  NoneBot2 (框架层)                       │
│  ┌──────────────────────────────────────────────────┐  │
│  │            消息路由与事件分发                     │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│                   应用层 (src/)                          │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  触发器层   │  │  插件层     │  │  对话智能   │    │
│  │  (triggers) │  │  (plugins)  │  │  (dialogue) │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
│         │                │                │            │
│  ┌──────▼────────────────▼────────────────▼──────┐    │
│  │            核心处理层 (chat_handler)           │    │
│  └──────┬─────────────────────────────────────────┘    │
│         │                                               │
│  ┌──────▼──────┐  ┌──────────┐  ┌──────────┐         │
│  │  记忆系统   │  │  AI客户端 │  │  工具层   │         │
│  │  (memory)   │  │  (ai)     │  │  (utils)  │         │
│  └─────────────┘  └──────────┘  └──────────┘         │
└──────────────────────────────────────────────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
┌───────▼──────┐ ┌──▼────┐ ┌────▼──────┐
│ SQLite数据库 │ │ Chroma │ │ 外部API   │
│  (bot.db)    │ │ 向量库 │ │ (DeepSeek)│
└──────────────┘ └────────┘ │ (阿里云)  │
                             └───────────┘
```

### 数据流向

```
用户消息 → NapCat → NoneBot2 → 触发器判断 → 插件处理
                                              ↓
                                         意图分析
                                              ↓
                                         记忆检索
                                              ↓
                                         AI生成回复
                                              ↓
                                         发送消息
```

---

## 📦 模块详解

### 1. 对话智能模块 (dialogue/)

#### 1.1 意图分析器 (intent_analyzer.py)

**功能**：理解用户消息的真实意图

**子模块**：
- **反问检测器 (CounterQuestionDetector)**
  - 识别用户反问机器人之前的问题
  - 维护问题栈（最近3个问题）
  - 支持模式：`你呢？`、`那你呢？`、`你觉得呢？`

- **讽刺识别器 (SarcasmDetector)**
  - 检测讽刺语气（置信度评分）
  - 特征：标点符号（`~`、`...`）、语气词（`呵`、`切`）
  - 反向模式：`真厉害呢`、`可真行`

- **话题追踪器 (TopicTracker)**
  - 使用jieba分词提取关键词
  - Jaccard相似度计算话题相关性
  - 连续3条不相关消息触发话题切换

**技术实现**：
```python
# 意图分析流程
message → 反问检测 → 讽刺识别 → 话题追踪 → IntentResult
```

#### 1.2 对话状态机 (state_machine.py)

**功能**：管理对话的生命周期

**状态定义**：
- `OPENING`：对话开启（前2条消息）
- `MAINTAINING`：维持对话（正常交流）
- `SWITCHING`：话题切换（过渡阶段）
- `CLOSING`：对话结束（5分钟无消息）

**状态转换**：
```
OPENING → MAINTAINING → SWITCHING → MAINTAINING
                ↓
            CLOSING
```

#### 1.3 上下文增强器 (context_enhancer.py)

**功能**：根据对话状态和意图优化AI的prompt

**增强内容**：
- 状态提示（如：开启状态 → "友好开放，主动问候"）
- 意图提示（如：检测到讽刺 → "理解真实意图"）
- 话题信息（当前话题、话题切换提示）

#### 1.4 主动对话引擎 (proactive_engine.py)

**功能**：让机器人主动发起话题

**子模块**：
- **冷场检测器 (ColdDetector)**
  - 三级检测：轻度(5分钟)、中度(10分钟)、重度(20分钟)
  - 不同等级对应不同主动概率

- **插话判断器 (InterjectionJudge)**
  - 冷却机制：10分钟冷却期
  - 频率限制：1小时最多3次
  - 概率控制：避免过度打扰

- **话题生成器 (TopicGenerator)**
  - 17个预设话题库
  - 根据氛围筛选（excited/calm/quiet/low）
  - 排除最近使用过的话题

---

### 2. 记忆系统 (memory/)

#### 2.1 三层架构

```
┌─────────────────────────────────────────┐
│  短期记忆 (context.py)                   │
│  - 内存缓存 (LRU)                        │
│  - 最近30条消息                          │
│  - 30分钟超时                            │
│  - 响应速度: ~5ms                        │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  长期记忆 (database.py)                  │
│  - SQLite数据库                          │
│  - 永久保存所有消息                      │
│  - 结构化查询                            │
│  - 支持精确检索                          │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│  语义记忆 (vector_store.py)              │
│  - Chroma向量数据库                      │
│  - 阿里云Embedding API                   │
│  - 语义相似度搜索                        │
│  - 响应速度: ~200-500ms                  │
└─────────────────────────────────────────┘
```

#### 2.2 记忆管理器 (memory_manager.py)

**功能**：统一管理三层记忆

**核心方法**：
- `add_message()`: 同时写入三层存储
- `get_context_for_ai()`: 获取AI所需上下文
- `search_related_memories()`: 语义搜索相关记忆

**工作流程**：
```python
# 添加消息
用户消息 → 短期记忆(内存) → 长期记忆(SQLite) → 语义记忆(向量库)

# 检索上下文
当前查询 → 短期记忆(最近30条) + 语义搜索(相关历史) → AI上下文
```

#### 2.3 群友数据库 (member_db.py)

**功能**：管理群友信息

**数据表结构**：
```sql
CREATE TABLE members (
    qq_id TEXT PRIMARY KEY,
    nickname TEXT,
    ai_nickname TEXT,        -- AI推测的昵称
    ai_nickname_confirmed INTEGER,
    birthday TEXT,           -- MM-DD格式
    notes TEXT,              -- 备注信息
    avatar_url TEXT,
    first_seen_at TEXT,
    last_seen_at TEXT,
    message_count INTEGER
)
```

---

### 3. AI客户端 (ai/)

#### 3.1 AI客户端 (client.py)

**功能**：与DeepSeek API交互

**核心功能**：
- 流式对话生成
- 人设注入（system prompt）
- 联网搜索结果融合
- 群友信息上下文

#### 3.2 提示词管理 (prompts.py)

**人设系统**：
```python
personality = {
    "name": "沉舟",
    "nickname": "舟舟",
    "traits": ["腼腆", "害羞", "温柔", "善良"],
    "speaking_style": "语气柔和，经常用省略号"
}
```

**动态Prompt**：
- 基础人设
- 群友信息
- 对话状态提示
- 意图分析提示

#### 3.3 昵称分析器 (nickname_analyzer.py)

**功能**：AI推测群友的简短昵称

**流程**：
```
群友发言 → 提取特征 → AI分析 → 推测昵称 → 管理员确认
```

---

### 4. 触发器系统 (triggers/)

#### 4.1 触发器类型

| 触发器 | 文件 | 优先级 | 说明 |
|--------|------|--------|------|
| @触发 | chat_handler.py | 5 | 被@时必定回复 |
| 关键词触发 | keyword.py | 10 | 检测预设关键词 |
| 名字触发 | name.py | 15 | 提到机器人名字 |
| 智能触发 | smart.py | 20 | AI判断是否回复 |

#### 4.2 定时任务 (scheduler.py)

**功能**：
- 早安问候（08:00）
- 晚安问候（23:00）
- 生日提醒（09:00检查）
- 随机话题（可配置）

---

### 5. 功能插件 (plugins/)

#### 5.1 聊天处理器 (chat_handler.py)

**核心流程**：
```python
1. 接收消息
2. 内容过滤检查
3. 意图分析
4. 联网搜索（如需要）
5. 记忆检索
6. 上下文增强
7. AI生成回复
8. 保存记忆
9. 发送消息
```

#### 5.2 B站链接解析 (bilibili.py)

**功能**：
- 自动识别B站链接
- 解析视频/番剧信息
- 格式化展示

#### 5.3 群友管理 (member_manager.py)

**命令列表**：
- `/生日 @用户 12-25` - 设置生日
- `/备注 QQ号 备注内容` - 添加备注
- `/昵称 @用户 昵称` - 设置昵称
- `/查询 @用户` - 查询信息
- `/统计` - 活跃度排行

#### 5.4 主动对话插件 (proactive_chat.py)

**功能**：
- 定时检查冷场（每60秒）
- 调用主动对话引擎
- 发送破冰话题

---

### 6. 工具层 (utils/)

#### 6.1 联网搜索 (web_search.py)

**功能**：基于阿里云Web-Search API

**触发关键词**：
- 天气、时间、新闻、热搜
- 笑话、段子
- 股票、金价、汇率

#### 6.2 内容过滤 (content_filter.py)

**功能**：
- 敏感词检测
- 违规内容拦截
- 警告消息生成

#### 6.3 配置管理 (config.py)

**功能**：
- YAML配置加载
- 环境变量管理
- 配置热更新

#### 6.4 日志系统 (logger.py)

**功能**：
- 分级日志（DEBUG/INFO/WARNING/ERROR）
- 按日期分割日志文件
- 错误日志单独记录

---

## 🔧 技术栈

### 核心框架
- **NoneBot2**: 异步机器人框架
- **NapCat**: QQ协议实现
- **OneBot V11**: 标准化协议

### AI与NLP
- **DeepSeek API**: 对话生成
- **阿里云DashScope**: Embedding + 联网搜索
- **jieba**: 中文分词

### 数据存储
- **SQLite**: 关系型数据库
- **Chroma**: 向量数据库
- **LRU Cache**: 内存缓存

### 开发工具
- **Python 3.9+**: 编程语言
- **asyncio**: 异步编程
- **YAML**: 配置文件
- **dotenv**: 环境变量管理

---

## 📊 性能指标

### 响应时间
- 短期记忆检索: ~5ms
- 长期记忆查询: ~20ms
- 向量语义搜索: ~200-500ms
- AI对话生成: ~1-3s
- 联网搜索: ~500-1000ms

### 资源占用
- 内存: 200-500MB
- CPU: <5% (空闲时)
- 磁盘: 1000条消息约6MB

### 并发能力
- 支持多群同时运行
- 异步处理，无阻塞
- 消息队列管理

---

## 🎯 核心算法

### 1. 话题相关性计算（Jaccard相似度）

```python
def calculate_relevance(keywords1, keywords2):
    set1, set2 = set(keywords1), set(keywords2)
    intersection = len(set1 & set2)
    union = len(set1 | set2)
    return intersection / union if union > 0 else 0.0
```

### 2. 讽刺检测评分

```python
score = 0.0
if has_punctuation_features:  # ~, ..., !!!
    score += 0.25
if has_tone_words:  # 呵, 切, 哦~
    score += 0.35
if matches_reverse_pattern:  # 真厉害呢
    score += 0.35
is_sarcastic = score >= threshold  # 默认0.6
```

### 3. 主动对话概率

```python
probability = 0.0
if is_mentioned:
    probability = 0.8
elif is_relevant:
    probability += 0.4
elif is_cold:
    probability += cold_level_probability  # 0.2/0.5/0.8

# 安全检查
if in_cooldown or too_active:
    probability = 0.0
```

### 4. 向量相似度搜索

```python
# 使用Chroma的余弦相似度
query_embedding = get_embedding(query)
results = vector_store.query(
    query_embeddings=[query_embedding],
    n_results=5,
    where={"chat_type": chat_type}
)
# 过滤距离 > 0.5 的结果
filtered = [r for r in results if r['distance'] < 0.5]
```

---

## 🔐 安全与隐私

### 数据安全
- 本地存储：所有数据存储在本地
- API密钥：使用环境变量管理
- 敏感信息：不记录密码等敏感数据

### 内容安全
- 敏感词过滤
- 违规内容拦截
- 管理员权限控制

### 隐私保护
- 向量数据需发送到阿里云生成
- 对话内容发送到DeepSeek
- 建议：不在机器人对话中讨论隐私信息

---

## 📈 扩展性设计

### 插件系统
```python
# 添加新插件只需：
# 1. 在 src/plugins/ 创建文件
# 2. 使用 NoneBot2 装饰器
# 3. 自动加载

from nonebot import on_command

my_plugin = on_command("mycommand")

@my_plugin.handle()
async def handle_my_command():
    # 处理逻辑
    pass
```

### 触发器扩展
```python
# 添加新触发器：
# 1. 在 src/triggers/ 创建文件
# 2. 定义优先级和规则
# 3. 实现处理逻辑
```

### 配置驱动
```yaml
# 所有功能都可通过配置开关
features:
  new_feature: true

new_feature:
  param1: value1
  param2: value2
```

---

## 🐛 已知限制

### 功能限制
1. 单群运行（可扩展为多群）
2. 仅支持文本消息（图片、语音待开发）
3. 向量搜索依赖外部API

### 性能限制
1. 向量搜索较慢（200-500ms）
2. AI生成有延迟（1-3s）
3. 大量历史消息会影响检索速度

### API限制
1. DeepSeek API有速率限制
2. 阿里云搜索有月度额度
3. Embedding API有QPS限制

---

## 📚 相关文档

- [README.md](../README.md) - 快速开始指南
- [DEPLOYMENT.md](DEPLOYMENT.md) - 部署文档
- [DIALOGUE_INTELLIGENCE.md](DIALOGUE_INTELLIGENCE.md) - 对话智能详解
- [VECTOR_MEMORY.md](VECTOR_MEMORY.md) - 向量记忆系统
- [WEB_SEARCH.md](WEB_SEARCH.md) - 联网搜索功能

---

## 👥 贡献指南

### 代码规范
- 使用类型注解
- 遵循PEP 8
- 添加文档字符串
- 编写单元测试

### 提交规范
```
feat: 添加新功能
fix: 修复bug
docs: 更新文档
refactor: 重构代码
test: 添加测试
```

### 开发流程
1. Fork项目
2. 创建功能分支
3. 提交代码
4. 发起Pull Request

---

**最后更新**: 2026-02-14
**文档版本**: v1.0.0
