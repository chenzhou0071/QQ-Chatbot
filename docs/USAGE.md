# 使用文档

## 功能说明

### 1. @触发回复

**使用方式**：在群里@机器人

**示例**：
```
@小助手 今天天气怎么样？
@小助手 讲个笑话
```

**特点**：
- 优先级最高，必定回复
- 支持上下文记忆
- 回复自然流畅

### 2. 关键词触发

**使用方式**：发送包含关键词的消息

**默认关键词**：
- 天气
- 时间
- 笑话
- 故事
- 新闻
- 早安
- 晚安

**示例**：
```
今天天气怎么样？  → 触发
给我讲个笑话      → 触发
你好              → 不触发
```

**自定义关键词**：
编辑 `config/config.yaml`：
```yaml
keywords:
  - "天气"
  - "你的关键词"
```

### 3. 智能判断回复

**使用方式**：正常聊天，机器人自动判断是否参与

**触发条件**：
- 30%概率触发（可配置）
- 距离上次回复至少60秒
- AI判断需要回复

**示例**：
```
用户A: 今天好无聊啊
机器人: 要不要我给大家讲个笑话？  ← 智能判断触发

用户B: 哈哈哈
机器人: （不回复）  ← AI判断不需要回复
```

**配置**：
```yaml
smart_reply:
  trigger_rate: 0.3      # 触发概率
  min_interval: 60       # 最小间隔(秒)
```

### 4. 定时任务

#### 早安问候

**时间**：每天09:00

**消息**：随机选择一条早安消息

**配置**：
```yaml
auto_chat:
  morning:
    enabled: true
    time: "09:00"
    messages:
      - "大家早安！☀️"
      - "早上好！"
```

#### 晚安问候

**时间**：每天23:00

**消息**：随机选择一条晚安消息

#### 随机话题

**频率**：每2小时

**概率**：30%

**作用**：活跃群气氛

### 5. 管理员私聊

**权限**：仅管理员可私聊机器人

**用途**：
- 测试机器人功能
- 私密对话
- 配置查询

**配置管理员**：
```yaml
bot:
  admin_qq: "你的QQ号"
```

## 对话记忆

### 记忆范围

- **群聊**：独立的上下文
- **私聊**：独立的上下文
- **最大消息数**：20条
- **超时时间**：30分钟无活动自动清空

### 记忆内容

机器人会记住：
- 最近的对话内容
- 发送者昵称（群聊）
- 对话时间

### 示例

```
用户: 我叫张三
机器人: 你好张三！

（5分钟后）

用户: 我叫什么名字？
机器人: 你叫张三呀！
```

## 配置管理

### 功能开关

```yaml
features:
  mention_reply: true      # @回复
  keyword_reply: true      # 关键词回复
  smart_reply: true        # 智能判断
  auto_chat: true          # 主动聊天
  chat_log: true           # 聊天日志
```

### 修改回复风格

编辑 `src/ai/prompts.py`：

```python
SYSTEM_PROMPT = """你是一个活泼友好的QQ群聊机器人助手。

你的特点：
- 性格开朗、幽默风趣
- 回复简洁自然
- 适当使用emoji
"""
```

### 切换AI提供商

编辑 `config/.env`：

```env
# 使用DeepSeek
AI_PROVIDER=deepseek
DEEPSEEK_API_KEY=sk-xxxxx

# 或使用通义千问
AI_PROVIDER=qwen
QWEN_API_KEY=sk-xxxxx
```

## 日志查看

### 日志位置

- 普通日志：`data/logs/bot-YYYY-MM-DD.log`
- 错误日志：`data/logs/error-YYYY-MM-DD.log`

### 日志格式

```
[2026-02-06 10:00:00] [INFO] [chat_handler] [群] 收到@消息: 张三: 你好
[2026-02-06 10:00:01] [INFO] [ai] AI回复成功: 你好呀！
[2026-02-06 10:00:02] [INFO] [chat_handler] [群] AI回复: 你好呀！
```

### 日志级别

- **DEBUG**：详细调试信息
- **INFO**：关键操作
- **WARNING**：警告信息
- **ERROR**：错误信息

## 数据管理

### 数据库位置

`data/bot.db`

### 清空对话记忆

```sql
DELETE FROM conversation_context;
```

或直接删除数据库文件（会自动重建）

### 查看聊天记录

```sql
SELECT * FROM chat_log ORDER BY created_at DESC LIMIT 100;
```

## 常用操作

### 重启机器人

1. 关闭当前运行的机器人（Ctrl+C）
2. 运行 `run.bat`

### 更新配置

1. 编辑配置文件
2. 重启机器人

### 查看运行状态

查看最新日志：
```bash
type data\logs\bot-2026-02-06.log
```

### 测试配置

```bash
venv\Scripts\activate
python test_config.py
```

## 最佳实践

### 1. 合理设置触发概率

- 活跃群：降低智能判断概率（10-20%）
- 冷清群：提高智能判断概率（30-50%）

### 2. 定期查看日志

- 检查是否有错误
- 了解机器人行为
- 优化配置

### 3. 备份数据

定期备份 `data/bot.db`

### 4. 监控API使用

- 查看API调用次数
- 控制成本
- 避免超额

### 5. 优化提示词

根据实际效果调整 `SYSTEM_PROMPT`

## 故障排查

### 机器人不回复

1. 检查日志是否有错误
2. 确认配置文件正确
3. 测试AI连接
4. 检查NapCat状态

### AI回复异常

1. 检查API密钥
2. 确认账户余额
3. 查看错误日志
4. 尝试切换AI提供商

### 内存占用过高

1. 清空对话记忆
2. 减少最大消息数
3. 重启机器人

### 数据库错误

1. 备份数据库
2. 删除并重建
3. 检查磁盘空间
